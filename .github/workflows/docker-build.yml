name: Build and Push Docker Images

on:
  push:
    tags:
      - 'v*'

env:
  REGISTRY: ghcr.io

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version and image names
        id: meta
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
          echo "backend_image=ghcr.io/${REPO_LOWER}/backend" >> "$GITHUB_OUTPUT"
          echo "frontend_image=ghcr.io/${REPO_LOWER}/frontend" >> "$GITHUB_OUTPUT"

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ---- Backend ----
      - name: Build and push backend image
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ steps.meta.outputs.backend_image }}:${{ steps.meta.outputs.version }}
            ${{ steps.meta.outputs.backend_image }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ---- Frontend ----
      - name: Build and push frontend image
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ steps.meta.outputs.frontend_image }}:${{ steps.meta.outputs.version }}
            ${{ steps.meta.outputs.frontend_image }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ---- æ‰“åŒ…éƒ¨ç½²ç‰©æ–™ ----
      - name: Package deployment bundle
        run: |
          VERSION=${{ steps.meta.outputs.version }}
          BUNDLE_DIR="image-sync-${VERSION}"

          mkdir -p "${BUNDLE_DIR}/data"

          # å¤åˆ¶ docker-compose å¹¶æ›¿æ¢ç‰ˆæœ¬å ä½ç¬¦
          sed "s/__VERSION__/${VERSION}/g" deploy/docker-compose.prod.yml > "${BUNDLE_DIR}/docker-compose.yml"

          # å¤åˆ¶éƒ¨ç½²è„šæœ¬
          cp deploy/common.sh "${BUNDLE_DIR}/"
          cp deploy/start.sh "${BUNDLE_DIR}/"
          cp deploy/stop.sh "${BUNDLE_DIR}/"
          cp deploy/restart.sh "${BUNDLE_DIR}/"
          cp deploy/logs.sh "${BUNDLE_DIR}/"
          cp deploy/status.sh "${BUNDLE_DIR}/"
          cp deploy/exec.sh "${BUNDLE_DIR}/"
          cp deploy/pull.sh "${BUNDLE_DIR}/"
          chmod +x "${BUNDLE_DIR}"/*.sh

          # å¤åˆ¶ç¯å¢ƒå˜é‡æ¨¡æ¿
          cp deploy/data/.env.example "${BUNDLE_DIR}/data/.env.example"

          # åˆ›å»º README
          cat > "${BUNDLE_DIR}/README.md" << 'DEPLOY_README'
          # Docker Image Sync éƒ¨ç½²åŒ…

          ## å¿«é€Ÿéƒ¨ç½²

          ```bash
          # 1. å¤åˆ¶å¹¶ç¼–è¾‘é…ç½®æ–‡ä»¶
          cp data/.env.example data/.env
          vi data/.env

          # 2. å¯åŠ¨æœåŠ¡
          ./start.sh

          # 3. è®¿é—®
          # é»˜è®¤åœ°å€: http://localhost:8080
          ```

          ## ç®¡ç†å‘½ä»¤

          | å‘½ä»¤ | è¯´æ˜ |
          |------|------|
          | `./start.sh` | å¯åŠ¨æœåŠ¡ |
          | `./stop.sh` | åœæ­¢æœåŠ¡ |
          | `./restart.sh` | é‡å¯æœåŠ¡ |
          | `./logs.sh` | æŸ¥çœ‹æ—¥å¿—ï¼ˆå¯è¿½åŠ æœåŠ¡åï¼‰ |
          | `./status.sh` | æŸ¥çœ‹çŠ¶æ€ |
          | `./exec.sh` | è¿›å…¥å®¹å™¨ï¼ˆé»˜è®¤ backendï¼‰ |
          | `./pull.sh` | æ‹‰å–æœ€æ–°é•œåƒ |

          ## é…ç½®è¯´æ˜

          ç¼–è¾‘ `data/.env` æ–‡ä»¶ï¼š

          | å˜é‡ | è¯´æ˜ | é»˜è®¤å€¼ |
          |------|------|--------|
          | `HARBOR_REGISTRY` | Harbor åœ°å€ | - |
          | `HARBOR_USERNAME` | Harbor ç”¨æˆ·å | - |
          | `HARBOR_PASSWORD` | Harbor å¯†ç  | - |
          | `FRONTEND_PORT` | å‰ç«¯è®¿é—®ç«¯å£ | 8080 |

          ## å‰ç½®è¦æ±‚

          - Docker 20.10+
          - Docker Compose v2ï¼ˆæˆ– docker-compose v1.29+ï¼‰
          - èƒ½è®¿é—® ghcr.ioï¼ˆæ‹‰å–é•œåƒï¼‰
          DEPLOY_README

          # å»æ‰ heredoc ç¼©è¿›
          sed -i 's/^          //' "${BUNDLE_DIR}/README.md"

          # æ‰“åŒ…
          tar czf "${BUNDLE_DIR}.tar.gz" "${BUNDLE_DIR}"
          echo "bundle_name=${BUNDLE_DIR}" >> "$GITHUB_OUTPUT"
          echo "bundle_file=${BUNDLE_DIR}.tar.gz" >> "$GITHUB_OUTPUT"

      # ---- åˆ›å»º GitHub Release ----
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          name: "Release ${{ steps.meta.outputs.tag }}"
          body: |
            ## Docker Image Sync ${{ steps.meta.outputs.tag }}

            ### ğŸ³ Docker é•œåƒ

            ```bash
            docker pull ${{ steps.meta.outputs.backend_image }}:${{ steps.meta.outputs.version }}
            docker pull ${{ steps.meta.outputs.frontend_image }}:${{ steps.meta.outputs.version }}
            ```

            ### ğŸ“¦ ä¸€é”®éƒ¨ç½²

            1. ä¸‹è½½ä¸‹æ–¹éƒ¨ç½²åŒ… `image-sync-${{ steps.meta.outputs.version }}.tar.gz`
            2. è§£å‹åˆ°æœåŠ¡å™¨
            3. ç¼–è¾‘é…ç½®å¹¶å¯åŠ¨

            ```bash
            tar xzf image-sync-${{ steps.meta.outputs.version }}.tar.gz
            cd image-sync-${{ steps.meta.outputs.version }}
            cp data/.env.example data/.env
            vi data/.env
            ./start.sh
            ```

            è®¿é—® `http://<æœåŠ¡å™¨IP>:8080`
          files: |
            image-sync-${{ steps.meta.outputs.version }}.tar.gz
          draft: false
          prerelease: false

      - name: Summary
        run: |
          echo "## ğŸ³ Docker Images Published" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Image | Tags |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-------|------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| \`${{ steps.meta.outputs.backend_image }}\` | \`${{ steps.meta.outputs.version }}\`, \`latest\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| \`${{ steps.meta.outputs.frontend_image }}\` | \`${{ steps.meta.outputs.version }}\`, \`latest\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "## ğŸ“¦ Deployment Bundle" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Release: [${{ steps.meta.outputs.tag }}](https://github.com/${{ github.repository }}/releases/tag/${{ steps.meta.outputs.tag }})" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### æ‹‰å–å‘½ä»¤" >> "$GITHUB_STEP_SUMMARY"
          echo "\`\`\`bash" >> "$GITHUB_STEP_SUMMARY"
          echo "docker pull ${{ steps.meta.outputs.backend_image }}:${{ steps.meta.outputs.version }}" >> "$GITHUB_STEP_SUMMARY"
          echo "docker pull ${{ steps.meta.outputs.frontend_image }}:${{ steps.meta.outputs.version }}" >> "$GITHUB_STEP_SUMMARY"
          echo "\`\`\`" >> "$GITHUB_STEP_SUMMARY"
